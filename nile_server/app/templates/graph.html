{% extends 'base.html' %}

{% block head %}
{% endblock %}

{% block body %}
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark special-color-dark">
    <!-- Navbar brand -->
    <a class="navbar-brand text-uppercase" href="#">Loadtest Manager</a>

    <!-- NavBar Items -->
    <ul class="navbar-nav mr-auto">
        <a class="dropdown-item text-light" href="http://localhost:5000/tests/">View Test List</a>
    </ul>
    <!-- NavBar Items -->

</nav>
<!-- Navbar -->

<!--Main Layout-->
<main>
    <div class="content p-3 mb-2 overflow-hidden">
        <h1>Visualize Test Results</h1>
    </div>
    r
    <div class="container">
        <div class="row">
            <div class="btn-group" role="group" aria-label="Results Option">
                <button type="button" class="btn btn-primary" onclick="showLocustFunction()" style="max-height: 50px;">Locust Results</button>
                <button type="button" class="btn btn-primary" onclick="showSystemMetricsFunction()" style="max-height: 50px;">System Metrics</button>
            </div>
            <div class="col" style="margin-top:-2%">
                <div class="row justify-content-center">
                    <label class="main-text drop-lead">Filter Requests:</label>
                </div>
                <div class="row justify-content-center">
    
                    <div class="btn-pair timepicker-small">
                        <label class="list-text">From:</label>
                        <input id="stampFilterFrom">
                    </div>
                    <div class="btn-pair">
                        <label class="list-text">To:</label>
                        <input id="stampFilterTo">
                    </div>
                </div>
            </div>
            
            
        </div>
        <div class="row pt-3">

            <div class="col-md-3">

                <div class="row justify-content-center">
                    <label class="main-text">Find Tests:</label>
                </div>
                <div class="row justify-content-end">
                    <label class="list-text" data-provide="datepicker">From:</label>
                    <input data-date-format="mm/dd/yyyy" id="datepickerFrom" name="foo" class="date-pair">
                </div>

                <div class="row justify-content-end">
                    <label class="list-text" >To:</label>
                    <input data-date-format="mm/dd/yyyy" data-date-end-date="0d" id="datepickerTo" class="date-pair">
                </div>

              <div class="row-5 pt-3">
                <div style="height:300px; width:300px;line-height:3em;overflow:auto;padding:5px;border-style: solid;border-color: rgb(220, 222, 231);border-width: 2px;">
                    {% for test in tests %}
                    <ul class="list-group" id="test-table">
                        <li class="list-group-item list-select" id="{{ test.id }}-item">
                            <div class="list-text dark-text"  id="{{ loop.index }}-id">Test {{ test.id }}</div>
                            <div class="list-text">
                                <a class="dark-text">Configuration: </a>
                                {{ test.config }}
                            </div>
                            <div class="list-text">
                                <a class="dark-text">Completed: </a>
                                <a id="{{ test.id }}-end">{{ test.end }}</a>
                            </div>
                        </li>
                    </ul>
                    {% endfor %}
                </div>
              </div>

            </div>

            <div class="col-md-7 chart">
                <canvas id="chart" width="10" height="9"></canvas>
            </div>
            

        </div>
    </div>

    <script type="text/javascript">

        
        // Get list of tests from Flask as JSON
        var tests = {{ tests|tojson }};
        var requests = {{ requests|tojson }};
        var $listRows = $('.list-select'); 
        var $selectedTest = ""
        var $responseTimes = []
        var $timestamps = []
        var $startTime = ""
        var $endTime = ""
        var ctx = document.getElementById('chart').getContext('2d');


        window.onload = function() {
            if (tests.length > 0) createChart(tests[0].id)
            document.getElementById(tests.length+'-item').click()
            filterTests()
            filterRequests()
        }
        
        $('#datepickerFrom').datepicker({
            weekStart: 1,
            daysOfWeekHighlighted: "6,0",
            autoclose: true,
            todayHighlight: true,
            buttonText: "From date",
        }).on("changeDate", function (e) {
            filterTests()
        });
        $('#datepickerFrom').datepicker("setDate", Date.parse(tests[0].start))

        $('#datepickerTo').datepicker({
            weekStart: 1,
            daysOfWeekHighlighted: "6,0",
            autoclose: true,
            todayHighlight: true,
            buttonText: "To date"
        }).on("changeDate", function (e) {
            filterTests()
        });
        $('#datepickerTo').datepicker("setDate", Date.parse(tests[tests.length-1].start))

        $('#stampFilterFrom').datetimepicker({
            icons:
            {
                up: 'fa fa-angle-up',
                down: 'fa fa-angle-down'
            },
            format: 'HH:mm:ss'
        }).on("dp.change",function(e){
            var date = e.date;
            startTime = date.format("HH:mm:ss")
            filterRequests()
        })

        $('#stampFilterTo').datetimepicker({
            icons:
            {
                up: 'fa fa-angle-up',
                down: 'fa fa-angle-down'
            },
            format: 'HH:mm:ss'
        }).on("dp.change",function(e){
            var date = e.date;
            endTime = date.format("HH:mm:ss")
            filterRequests()
        })

        function filterTests() {
            console.log(tests)

            var startDate = $('#datepickerFrom').datepicker('getDate')
            var endDate = $('#datepickerTo').datepicker('getDate')

            console.log(startDate)
            console.log(endDate)

            for(var i = 0; i < tests.length; i++) {

                start = Date.parse(tests[i].start)
                if (tests[i].end != null) end = Date.parse(tests[i].end).toLocaleString()
                else end = "Not Complete"

                document.getElementById((i + 1) + '-end').innerHTML = end;
                if (start >= startDate && start <= endDate) {
                    document.getElementById((i + 1) + '-item').style.display = '';
                } else {
                    document.getElementById((i + 1) + '-item').style.display = 'none';
                }
            }
        }

        function filterRequests() {
            console.log(requests)

            var startTime = $('#stampFilterFrom').datepicker('getDate')
            var endTime = $('#stampFilterTo').datepicker('getDate')

            console.log(startTime)
            console.log(endTime)

            filtered = {{ requests|tojson }};
            requests = []

            for(var i = 0; i < requests.length; i++) {

                timestamp = Date.parse(requests[i].timestamp).toLocaleString()
                
                document.getElementById((i + 1) + '-end').innerHTML = end;
                if (timestamp >= startDate && timestamp <= endDate) {
                    console.log((i+1) + " show")
                    requests.push(requests[i])
                } else {
                    console.log((i+1) + " none")
                }
            }
            if ($selectedTest) createChart($selectedTest.id)
            else createChart(tests[0].id)
        }

        /**
        * Highlight a selected a table row
        */ 
        $('.list-select').click(function(e) {
            $listRows.removeClass('active');
            $(this).addClass('active');
            $selectedTest = tests[this.id]
            console.log($selectedTest)

            createChart(this.id)

        });

        function createChart(id) {

            var $responseTimes = []
            var $timestamps = []
            
            if (chart) chart.destroy();
            var ctx = document.getElementById('chart').getContext('2d');
        
            var chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: $timestamps,
                    datasets: [{
                        label: "Response Time",
                        data: $responseTimes,
                        backgroundColor: [
                            'rgba(2, 99, 255, 0.2)',
                            'rgba(54, 162, 235, 0.2)',
                            'rgba(255, 206, 86, 0.2)',
                            'rgba(75, 192, 192, 0.2)',
                            'rgba(153, 102, 255, 0.2)',
                            'rgba(255, 159, 64, 0.2)'
                        ],
                        borderColor: [
                            'rgba(100, 99, 255, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        xAxes: [{
                            ticks: {
                                callback: function(t, i) {
                                    if (!(i % 4)) return t;
                                }
                            }
                        }]
                    }
                }
            });


            for(var i = 0; i < requests.length; i++) {
                if (requests[i].test_id == id) {
                    $responseTimes.push(requests[i].response_time)
                    $timestamps.push(requests[i].request_timestamp)
                    chart.config.data.labels.push(requests[i].request_timestamp);
                    chart.config.data.datasets[0].data.push(requests[i].response_time);
                }
            }
            console.log($responseTimes)
            console.log($timestamps)

            chart.update()
        }

        
        function showRequests() {
            var x = document.getElementById("test-group")
            var y = document.getElementById("test-group-2")
            if (x.style.display === "none") {
                x.style.display = "block"
                y.style.display = "none"
            }
        }
        function showMetrics() {
            var x = document.getElementById("test-group-2")
            var y = document.getElementById("test-group")
            if (x.style.display === "none") {
                x.style.display = "block"
                y.style.display = "none"
            }
        }
    </script>
</main>
<!--Main Layout-->

{% endblock %}