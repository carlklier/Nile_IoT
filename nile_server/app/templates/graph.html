{% extends 'base.html' %}

{% block head %}
{% endblock %}

{% block body %}
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark special-color-dark">
    <!-- Navbar brand -->
    <a class="navbar-brand" href="#">Loadtest Manager</a>

    <!-- NavBar Items -->
    <ul class="navbar-nav mr-auto">
        <a class="dropdown-item text-light" href="http://localhost:5000/tests/">View Test List</a>
    </ul>
    <!-- NavBar Items -->

</nav>
<!-- Navbar -->

<!--Main Layout-->
<main>
    <div class="content p-3 mb-2 overflow-hidden">
        <h1>Visualize Test Results</h1>
    </div>
    
    <div class="container" style="position:static">
        <div class="row">
                <div class="btn-group" role="group" aria-label="Results Option">
                    <button type="button" class="btn btn-primary" onclick="showRequests()" style="max-height: 50px;">Locust Results</button>
                    <button type="button" class="btn btn-primary" onclick="showMetrics()" style="max-height: 50px;">System Metrics</button>
                </div>
                <div class="col" style="margin-top:-2%">
                    <div class="row justify-content-center">
                        <label class="main-text drop-lead">Filter Requests:</label>
                    </div>
                    <div class="row justify-content-center">
        
                        <div class="btn-pair timepicker-small">
                            <label class="list-text">From:</label>
                            <input id="stampFilterFrom" style="max-width: 120px">
                        </div>
                        <div class="btn-pair">
                            <label class="list-text">To:</label>
                            <input id="stampFilterTo" style="max-width: 120px">
                        </div>
                    </div>
                </div>
            
            
        </div>
        <div class="row pt-3">

            <div class="col-md-3">

                <div class="row justify-content-center">
                    <label class="main-text">Find Tests:</label>
                </div>
                <div class="row justify-content-center">
                    <label class="list-text">From:</label>
                    <input data-date-format="mm/dd/yyyy" id="datepickerFrom" name="foo" class="date-pair" style="max-width: 100px;">
                </div>

                <div class="row justify-content-center">
                    <label class="list-text" >To:</label>
                    <input data-date-format="mm/dd/yyyy" data-date-end-date="0d" id="datepickerTo" class="date-pair" style="max-width: 100px;margin-left: 9%;">
                </div>

              <div class="row-5 pt-3">
                <div style="height:300px; width:250px;line-height:3em;overflow:auto;padding:5px;border-style: solid;border-color: rgb(220, 222, 231);border-width: 2px;">
                    {% for test in tests %}
                    <ul class="list-group" id="test-table">
                        <li class="list-group-item list-select" id="{{ test.id }}">
                            <div class="list-text dark-text"  id="{{ loop.index }}-id">Test {{ test.id }}</div>
                            <div class="list-text">
                                <a class="dark-text">Configuration: </a>
                                {{ test.config }}
                            </div>
                            <div class="list-text">
                                <a class="dark-text">Completed: </a>
                                <a id="{{ test.id }}-end">{{ test.end }}</a>
                            </div>
                        </li>
                    </ul>
                    {% endfor %}
                </div>
              </div>

            </div>

            <div class="col-md-7 chart">
                <canvas id="chart"></canvas>
            </div>
            

        </div>
    </div>

    <script type="text/javascript">

        
        // Get list of tests and requests from Flask as JSON
        var tests = {{ tests|tojson }};
        var requests = {{ requests|tojson }};
        var $listRows = $('.list-select'); 
        var $selectedTest = ""
        var $responseTimes = []
        var $timestamps = []
        var ctx = document.getElementById('chart').getContext('2d');

        /**
        * When the window loads, display the chart from the
        * most recent test data
        */ 
        window.onload = function() {
            if (tests.length <= 0) return 0

            var query = window.location.search.substring(1)

            // If user selected a test to visualize, load chart
            // with that id. Otherwise, grab the most recent test
            // available
            if (query) {
                var id = query.split("=")[1];
                console.log("id: " + (tests.length - parseInt(id)))
                document.getElementById(parseInt(id)).click()
            } else {
                document.getElementById(tests[0].id).click()
            }

            filterTests()
        }
        
        /**
        * Initialize datepickers and re-filter tests when updated
        */ 
        $('#datepickerFrom, #datepickerTo').datepicker({
            weekStart: 1,
            daysOfWeekHighlighted: "6,0",
            autoclose: true,
            todayHighlight: true,
            buttonText: "From date",
        }).on("changeDate", function (e) {
            filterTests()
        });
        $('#datepickerFrom').datepicker("setDate", Date.parse(tests[tests.length - 1].start))
        $('#datepickerTo').datepicker("setDate", moment().format("MMMM Do YYYY"))

        /**
        * Using datetimepicker, recreate chart on update
        * by checking request timestamps against the new
        * filter times
        */ 
        $('#stampFilterFrom').datetimepicker({
            icons:
            {
                up: 'fa fa-angle-up',
                down: 'fa fa-angle-down'
            },
            format: 'HH:mm:ss.SSS',
            defaultDate:moment(new Date()).hours(0).minutes(0).seconds(0).milliseconds(0)
        }).on("dp.change",function(e){
            if ($selectedTest) createChart($selectedTest.id)
            else createChart(tests[0].id, false)
        })
        $('#stampFilterTo').datetimepicker({
            icons:
            {
                up: 'fa fa-angle-up',
                down: 'fa fa-angle-down'
            },
            format: 'HH:mm:ss.SSS',
            defaultDate:moment(new Date()).hours(23).minutes(59).seconds(59)
        }).on("dp.change",function(e){
            if ($selectedTest) createChart($selectedTest.id)
            else createChart(tests[0].id, false)
        })

        /**
        * Filter the tests displayed based on the date picker
        */ 
        function filterTests() {

            var startDate = $('#datepickerFrom').datepicker('getDate')
            var endDate = $('#datepickerTo').datepicker('getDate')

            for(var i = 0; i < tests.length; i++) {

                id = tests[i].id
                start = Date.parse(tests[i].start)
                if (tests[i].end != null) end = Date.parse(tests[i].end).toLocaleString()
                else end = "Not Complete"

                document.getElementById(id + '-end').innerHTML = end;
                if (start >= startDate && start <= endDate) {
                    document.getElementById(id).style.display = '';
                } else {
                    document.getElementById(id).style.display = 'none';
                }
            }
        }

        /**
        * Highlight a selected a test in the table and update
        * the chart
        */ 
        $('.list-select').click(function(e) {
            $listRows.removeClass('active')
            $(this).addClass('active')
            $selectedTest = tests[tests.length - this.id]

            createChart(this.id, true)
        });

        /**
        * Creates a new chart by destroying the previous
        * chart and redrawing it with newly filtered values.
        * Date-times compared are converted to just HH:mm:ss
        * so only the time of day is compared.
        */ 
        function createChart(id, newTest) {

            var $responseTimes = []
            var $timestamps = []

            if (chart) chart.destroy();
            var ctx = document.getElementById('chart').getContext('2d');
        
            var chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: $timestamps,
                    datasets: [{
                        label: "Response Time",
                        data: $responseTimes,
                        backgroundColor: [
                            'rgba(2, 99, 255, 0.2)',
                            'rgba(54, 162, 235, 0.2)',
                            'rgba(255, 206, 86, 0.2)',
                            'rgba(75, 192, 192, 0.2)',
                            'rgba(153, 102, 255, 0.2)',
                            'rgba(255, 159, 64, 0.2)'
                        ],
                        borderColor: [
                            'rgba(100, 99, 255, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        xAxes: [{
                            ticks: {
                                callback: function(t, i) {
                                    if (!(i % 4)) return t;
                                }
                            }
                        }]
                    }
                }
            });

            var startTime = new Date($('#stampFilterFrom').data("DateTimePicker").date())
            var endTime = new Date($('#stampFilterTo').data("DateTimePicker").date())

            startTime = moment(startTime).format("HH:mm:ss.SSS")
            endTime = moment(endTime).format("HH:mm:ss.SSS")

            reqs = requests[id]

            for(var i = 0; i < reqs.length; i++) {
                var timestamp = moment(new Date(reqs[i].request_timestamp)).format('HH:mm:ss.SSS')

                $responseTimes.push(reqs[i].response_time)
                $timestamps.push(timestamp)
                chart.config.data.labels.push(timestamp);
                chart.config.data.datasets[0].data.push(reqs[i].response_time);

            }

            // If a new test is being selected, update the
            // start/end time to the earliest/latest timestamps in the
            // current test
            if (newTest && $timestamps.length > 0) {
                var start = $timestamps[0]
                var end = $timestamps[$timestamps.length-1]

                $("#stampFilterFrom").val(start)
                $("#stampFilterTo").val(end)
            }

            chart.update()
        }

        
        function showRequests() {
            var x = document.getElementById("test-group")
            var y = document.getElementById("test-group-2")
            if (x.style.display === "none") {
                x.style.display = "block"
                y.style.display = "none"
            }
        }
        function showMetrics() {
            var x = document.getElementById("test-group-2")
            var y = document.getElementById("test-group")
            if (x.style.display === "none") {
                x.style.display = "block"
                y.style.display = "none"
            }
        }
    </script>
</main>
<!--Main Layout-->

{% endblock %}