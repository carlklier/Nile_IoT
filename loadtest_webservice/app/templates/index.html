{% extends 'base.html' %}

{% block head %}
{% endblock %}

{% block body %}
<script>
    $(document).ready(function() {
        /**
         Initialize local variables
        */
        var $sortBy = "workers"
        var $tableRows = $('.table-select'); 
        var $selectedTest = ""

        // Get list of tests from Flask as JSON
        var list = {{ tests|tojson }};

        // Initialize view test header
        document.getElementById("view-test").innerHTML = "Select Test"
        
        // Initialize unfinished test end time
        list.forEach(iterate);

        /**
        * Highlight a selected a table row
        */ 
        $('.table-select').click(function(e) {
            $tableRows.removeClass('selected');
            $(this).addClass('selected');
            $selectedTest = $(this).find('th:first').text()
            document.getElementById("view-test").innerHTML =  "View Test " + $selectedTest
        });

        /**
        * Sort rows based on selected dropdown item
        */  
        $(".dropdown-menu a").click(function(){
            console.log($sortBy)
            if (this.id !== undefined)
                $sortBy = this.id;

            $(".dropdown-toggle:first-child").text($(this).text());
            $(".dropdown-toggle:first-child").val($(this).text());
            
            if ($sortBy === "start") {
                list.sort(function(a, b) {
                    a = new Date(a.start);
                    b = new Date(b.start);
                    return a < b ? -1 : a > b ? 1 : 0;
                });
            } else if ($sortBy === "workers") {
                list.sort((a, b) => b.workers - a.workers);
            } else if ($sortBy === "id") {
                list.sort((a, b) => a.id - b.id);
            }

            list.forEach(iterate)
        });
        
        $("#view-summary").click(function() {
            console.log("view sum")
            window.open("http://localhost:5000/tests/" + $selectedTest,"_self")
        });
        
        // Modify the table HTML to match the current sorting
        // of the test list
        function iterate(test, index) 
            { 
                console.log(test)
                index += 1
                
                if (test.end = '0001-01-01T00:00:00') test.end = "In Progress"

                document.getElementById(index + '-id').innerHTML = test.id
                document.getElementById(index + '-cfg').innerHTML = test.config
                document.getElementById(index + '-start').innerHTML = test.start
                document.getElementById(index + '-end').innerHTML = test.end
                document.getElementById(index + '-workers').innerHTML = test.workers
            }
    })
    

</script>
<nav class="navbar navbar-expand-lg navbar-dark special-color-dark">
    <!-- Navbar brand -->
    <a class="navbar-brand text-uppercase" href="#">Loadtest Manager</a>
</nav>

<div  class="content p-3 mb-2 overflow-hidden">
    <h1>View Tests</h1>
    <br>
    <div class="drop-pair">
        <div class="main-text drop-lead">Sort by:</div>
        
        <div class="dropdown">
            
            <button id ="drop-button" class="btn btn-primary btn-small dropdown-toggle px-3" type="button" data-toggle="dropdown"
            aria-haspopup="true" aria-expanded="false" name="sortBy">None</button>
            <div class="dropdown-menu">
                <a id ="drop-item" class="dropdown-item" id="start">Start Time</a>
                <a class="dropdown-item" id="workers">Workers</a>
                <a class="dropdown-item" id="id">ID</a>
            </div>
        </div>
    </div>
    
    
    <div class="row">
        <div class="col-lg-8 col-md-6">
            <div class="row">
                <table class="table table-hover table-sm">
                    <thead>
                        <tr>
                            <th scope="col">Test ID</th>
                            <th scope="col">Config</th>
                            <th scope="col">Start Time</th>
                            <th scope="col">End Time</th>
                            <th scope="col">Workers</th>
                        </tr>
                    </thead>
                    <tbody id="table">
                        {% for test in tests %}
                                <tr class="table-select">
                                    <th id="{{ loop.index }}-id" scope="row">{{ test.id }}</th>
                                    <td id="{{ loop.index }}-cfg">{{ test.config }}</td>
                                    <td id="{{ loop.index }}-start">{{ test.start }}</td>
                                    <td id="{{ loop.index }}-end">{{ test.end }}</td>
                                    <td id="{{ loop.index }}-workers">{{ test.workers }}</td>
                                </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="row">
                <div class="text-center btn-center">
                    <button class="arrow-btn btn-primary z-depth-2"><i class="fa fa-arrow-circle-left"></i></button>
                    
                    <button class="btn-middle btn-primary text-uppercase z-depth-2">Visualize Tests</button>

                    <button class="arrow-btn btn-primary z-depth-2"><i class="fa fa-arrow-circle-right"></i></button>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-6">
            <div class="box_section dark-text z-depth-2 text-center small-box">
                
                <h5 id="view-test" class="text-uppercase text-center" style="padding-top:10%;"></h5>
                <br>
                <div style="width:100%;margin:auto">
                    <button id="view-summary" type="button" class="btn btn-primary" style="width:250px">View Test Summary</button>
                    <br>
                    <button  id="view-data"type="button" class="btn btn-primary"style="width:250px">View Test Data</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}